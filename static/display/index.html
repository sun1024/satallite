<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>卫星接入认证监视系统</title>
    <link rel="stylesheet" href="static/static/bootstrap.min.css">
    <script src="static/static/jquery.min.js"></script>
    <script src="static/static/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/static/socket.io.min.js"></script>
    <script type="text/javascript" src="static/display/js/jquery.js"></script>
    <link rel="stylesheet" href="static/display/css/comon0.css">
    <style>
        #log {
            background-color: inherit;
            width: 100%;
            height: 347px;
        }

        #table {
            font-size: 0.17rem;
        }

        /* 禁止拖动 */
        textarea {
            resize: none;
            outline: none !important;
            border: 1px solid #31708f;
            box-shadow: 0 0 10px #719ECE;
        }
    </style>
</head>
<script>
    $(window).load(function () {
        $(".loading").fadeOut()
    })


    $(document).ready(function () {
        var whei = $(window).width()
        $("html").css({ fontSize: whei / 20 })
        $(window).resize(function () {
            var whei = $(window).width()
            $("html").css({ fontSize: whei / 20 })
        });
    });
</script>
<!-- <script type="text/javascript">
    $(document).ready(function () {
        var html = $(".wrap ul").html()
        $(".wrap ul").append(html)
        var ls = $(".wrap li").length / 2 + 1
        i = 0
        ref = setInterval(function () {
            i++
            if (i == ls) {
                i = 1
                $(".wrap ul").css({ marginTop: 0 })
                $(".wrap ul").animate({ marginTop: -'.52' * i + 'rem' }, 1000)
            }
            $(".wrap ul").animate({ marginTop: -'.52' * i + 'rem' }, 1000)


        }, 2400);



        var html2 = $(".adduser ul").html()
        $(".adduser ul").append(html2)
        var ls2 = $(".adduser li").length / 2 + 1
        a = 0
        ref = setInterval(function () {
            a++
            if (a == ls2) {
                a = 1
                $(".adduser ul").css({ marginTop: 0 })
                $(".adduser ul").animate({ marginTop: -'.5' * a + 'rem' }, 800)
            }
            $(".adduser ul").animate({ marginTop: -'.5' * a + 'rem' }, 800)


        }, 4300);

    })
</script> -->
<!-- <script type="text/javascript" src="js/echarts.min.js"></script> -->
<!-- <script language="JavaScript" src="js/js.js"></script> -->

<body>
    <div class="canvas" style="opacity: .2">
        <iframe frameborder="0" src="static/display/js/index.html" style="width: 100%; height: 100%"></iframe>
    </div>
    <div class="loading">
        <div class="loadbox"> <img src="static/display/images/loading.gif"> 页面加载中... </div>
    </div>
    <div class="head">
        <h1>卫星接入认证监视系统</h1>
        <div class="weather">
            <!--<img src="images/weather.png"><span>多云转小雨</span>--><span id="showTime"></span></div>

        <script>
            var t = null;
            t = setTimeout(time, 1000);
            function time() {
                clearTimeout(t);
                dt = new Date();
                var y = dt.getFullYear();
                var mt = dt.getMonth() + 1;
                var day = dt.getDate();
                var h = dt.getHours();
                var m = dt.getMinutes();
                var s = dt.getSeconds();
                document.getElementById("showTime").innerHTML = y + "年" + mt + "月" + day + "日" + "-" + h + "时" + m + "分" + s + "秒";
                t = setTimeout(time, 1000);
            }

        </script>


    </div>
    <div class="mainbox">
        <ul class="clearfix">
            <li>
                <div class="boxall" style="height: 4.3rem">
                    <div class="alltitle">用户消息</div>
                    <div>
                        <h2>
                            <h2><br>
                                <form>
                                    <p5 id="simple1"> 暂无消息 </p5><br><br>
                                    <p5 id="simpleResult1"> </p5>
                                </form>
                    </div>
                    <div class="boxfoot"></div>
                </div>
                <div class="boxall" style="height: 4.3rem">
                    <div class="alltitle">NCC消息</div>
                    <!-- <div class="barbox2">
                        <ul class="clearfix">
                            <li class="pulll" id="simple1"> 显示NCC消息 </li>
                            <li class="pulll" id="simple1"> 显示NCC消息 </li>
                            <li class="pulll" id="simple1"> 显示NCC消息 </li>
                            <li class="pulll" id="simple1"> 显示NCC消息 </li>
                        </ul>
                    </div> -->
                    <div>
                        <h2>
                            <h2><br>
                                <form>
                                    <p5 id="simple2"> 暂无消息 </p5><br><br>
                                    <p5 id="simpleResult2"> </p5>
                                </form>
                    </div>
                    <div class="boxfoot"></div>
                </div>
            </li>
            <li>
                <div class="bar">
                    <div class="barbox">
                        <ul class="clearfix">
                            <li class="pulll_left counter">12</li>
                            <li class="pulll_left counter">50%</li>
                        </ul>
                    </div>
                    <div class="barbox2">
                        <ul class="clearfix">
                            <li class="pulll_left">接入用户总数</li>
                            <li class="pulll_left">接入成功率</li>
                        </ul>
                    </div>
                </div>
                <div class="map">
                    <div class="map1"><img src="static/display/images/lbx.png"></div>
                    <div class="map2"><img src="static/display/images/jt.png"></div>
                    <div class="map3"><img src="static/display/images/map.png"></div>
                    <div class="map4" id="map_1"></div>
                </div>
            </li>
            <li>
                <div class="boxall" style="height:4.3rem">
                    <div class="alltitle">实时接入状态</div>
                    <div class="addnew">
                        <div class="tit02"><span>新增用户列表</span></div>
                        <table class="table" id="table">
                            <thead>
                                <tr>
                                    <th>
                                        接入用户
                                    </th>
                                    <th>
                                        接入时间
                                    </th>
                                    <th>
                                        接入状态
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- <tr>
                                    <td>
                                        IgpX****
                                    </td>
                                    <td>
                                        2019-06-27 09:52:38
                                    </td>
                                    <td>
                                        请求卫星
                                    </td>
                                </tr> -->
                            </tbody>
                        </table>
                    </div>
                    <div class="boxfoot"></div>
                </div>
                <div class="boxall" style="height: 4.3rem">
                    <div class="alltitle">接入日志信息</div>
                    <div align="center">
                        <textarea id="log" readonly="readonly" cols="30" rows="10">
						  </textarea>
                    </div>
                    <div class="boxfoot"></div>
                </div>
            </li>
        </ul>
    </div>
    <div class="back"></div>


    <!-- <script type="text/javascript" src="js/china.js"></script> -->
    <!-- <script type="text/javascript" src="js/area_echarts.js"></script> -->
    <script type="text/javascript" src="static/display/js/jquery.waypoints.min.js"></script>
    <script type="text/javascript" src="static/display/js/jquery.countup.min.js"></script>
    <script type="text/javascript">
        $('.counter').countUp();
    </script>

    <script type="text/javascript" charset="utf-8">
        $(document).ready(function () {
            var socket = io.connect();

            socket.on('connect', function () {
                // socket.emit('table_event', { data: 'table' });
                socket.emit('client_event', { data: 'client' });
            })

            // socket.on('table_response', function (msg){
            // 	console.log(msg);
            // })

            var tmp = '';
            var table = [];
            socket.on('server_response', function (msg) {
                console.log(msg);
                if (msg.data.length != 0 && tmp != msg.data[0]) {
                    change_tmp(msg.data)

                    // $('#log').append('<br>' + $('<div/>').text('Received #' + ': ' + msg.data).html());
                    // $('#log').prepend('<br>' + $('<div/>').text('\n' + time +' #' + ': ' + tmp).html());

                    obj = JSON.parse(msg.data[0])
                    console.log(obj)

                    var simple1 = document.getElementById('simple1');
                    var simpleResult1 = document.getElementById('simpleResult1');
                    var simple2 = document.getElementById('simple2');
                    var simpleResult2 = document.getElementById('simpleResult2');

                    time = fnDate();

                    if (obj.Ru) { //收到用户信息
                        var user = obj.PIDu.substring(0, 5) + "****";
                        simple1.innerHTML = "<h3>" + time + "</h3><br>接收到用户:<h3>" + user + "</h3>发起的身份认证请求\n";
                        simpleResult1.innerHTML = "<br><br>即将进行转发处理 </h6>";

                        $('#log').prepend('<br>' + $('<div/>').text('\n# ' + time + ' ---------- 接收到用户请求：\n' + tmp).html());

                        // setTable(user);
                        // console.log(table);
                        var status = '请求卫星';
                        // console.log(user + time + status)
                        toTable = '<tr><td>' + user + '</td><td>' + time + '</td><td>' + status + '</td></tr>';
                        $('#table tbody').prepend(toTable);
                        showTable();
                    }
                    else if (obj.userData) { //转发用户信息到ncc
                        var user = obj.userData.PIDu.substring(0, 5) + "****";
                        simple2.innerHTML = "<h3>" + time + "</h3><br>正在转发用户:<h3>" + user + "</h3>发起的身份认证请求\n";
                        simpleResult2.innerHTML = "<br><br>正在进行转发处理 </h6>";

                        $('#log').prepend('<br>' + $('<div/>').text('\n# ' + time + ' ---------- 转发用户请求到NCC：\n' + tmp).html());

                        var status = '转发NCC';
                        // 获取table中的该user行，并将status修改
                        changeTable(user, status);

                    }
                    else if (obj.ReqAuth == "ReqUserInfo") { //向ncc请求用户身份
                        var user = obj.PIDu.substring(0, 5) + "****";
                        simple2.innerHTML = "<h3>" + time + "</h3><br>正在向NCC请求用户:<h3>" + user + "</h3>的身份信息\n";
                        simpleResult2.innerHTML = "<br></h6>";

                        $('#log').prepend('<br>' + $('<div/>').text('\n# ' + time + ' ---------- 向NCC请求用户信息：\n' + tmp).html());

                        var status = '请求用户';
                        // 获取table中的该user行，并将status修改
                        changeTable(user, status);
                    }

                    else if (obj.ReqAuth == "200") { //ncc回复卫星，用户认证成功
                        var user = obj.PIDu.substring(0, 5) + "****";
                        // simple.innerHTML = "正在向NCC请求用户\n" + obj.PIDu + "<br>的身份信息\n";
                        simple1.innerHTML = "<h3>" + time + "</h3><br>用户:<h3>" + user + "</h3><font color='#FF0000'>认证成功</font><br><br>正在向用户返回成功认证消息";
                        simpleResult1.innerHTML = "<br></h6>";

                        $('#log').prepend('<br>' + $('<div/>').text('\n# ' + time + ' ---------- 用户认证成功：\n' + tmp).html());

                        var status = '认证成功';
                        // 获取table中的该user行，并将status修改
                        changeTable(user, status);
                    }

                    //错误处理
                    else if (obj.ReqAuth == "500") { //用户认证失败
                        var user = obj.PIDu.substring(0, 5) + "****";
                        simple1.innerHTML = "<h3>" + time + "</h3><br>用户:<h3>" + user + "</h3><font color='#FF0000'>认证失败</font>";
                        simpleResult1.innerHTML = "</h6>";

                        $('#log').prepend('<br>' + $('<div/>').text('\n # ' + time + ' ---------- 用户认证失败：\n' + tmp).html());

                        var status = '认证失败';
                        // 获取table中的该user行，并将status修改
                        changeTable(user, status);
                    }
                }
            });
            function fnDate() {
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                var data = date.getDate();
                var hours = date.getHours();
                var minute = date.getMinutes();
                var second = date.getSeconds();
                var time = year + "-" + fnW((month + 1)) + "-" + fnW(data) + " " + fnW(hours) + ":" + fnW(minute) + ":" + fnW(second);
                return time;
            }
            function fnW(str) {
                var num;
                str > 10 ? num = str : num = "0" + str;
                return num;
            }
            // 改变全局变量tmp的值
            function change_tmp(data) {
                $.ajax({
                    async: false,
                    success: function () {
                        tmp = data;
                    }
                })
            }
            function setTable(data) {
                $.ajax({
                    async: false,
                    success: function () {
                        table.push(data)
                    }
                })
            }

            function changeTable(user, status) {
                var v = "";
                var key = 0;
                $("#table tr td:nth-child(1)").each(function () {
                    // console.log($(this).text());
                    if (user == $(this).text()) {
                        v = $("#table tr:gt(0):eq(" + key + ") td:eq(2)").text();
                        console.log(v);
                        // 改变status
                        $("#table tr:gt(0):eq(" + key + ") td:eq(2)").text(status);
                    }
                    key += 1;
                });
            }

        });

        // 只显示7行
        function showTable() {
            // 获取总行数
            rows = $("#table").find("tr").length
            if(rows>7){
                //如果规定显示行号，请用下面代码
                var showNumber = new Array(1, 2, 3, 4, 5, 6, 7);
    
                $("#table tr").hide();
                for (i = 0; i < showNumber.length; i++) {
                    $("#table tr:eq(" + showNumber[i] + ")").show();
                }
            }
        }
    </script>
</body>

</html>